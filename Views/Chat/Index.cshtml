@{
    // Kh√¥ng c·∫ßn Model n·ªØa v√¨ s·∫Ω load b·∫±ng AJAX
}

@{
    ViewData["Title"] = "Ph√≤ng Chat";
}

<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700;800&display=swap" rel="stylesheet">

<style>
    /* 1. KHUNG BAO NGO√ÄI (CƒÇN CH·ªàNH L·∫†I V·ªä TR√ç) */
    .chat-wrapper {
        font-family: 'Quicksand', sans-serif;
        height: 90vh;
        /* Chi·ªÅu cao b·∫±ng ƒë√∫ng m√†n h√¨nh */
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        /* QUAN TR·ªåNG: ƒê·∫©y xu·ªëng 90px ƒë·ªÉ n√© thanh Menu (Navbar) */
        padding-top: 60px;
        padding-bottom: 30px;
        /* C√°ch ƒë√°y m·ªôt ch√∫t cho tho√°ng */
        overflow: hidden;
        /* Ch·∫∑n thanh cu·ªôn ngo√†i */
    }

    /* 2. TH·∫∫ CHAT (GLASS) */
    .chat-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 25px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 1200px;
        /* R·ªông h∆°n x√≠u cho tho·∫£i m√°i */
        height: 100%;
        /* Chi·∫øm h·∫øt chi·ªÅu cao cho ph√©p trong wrapper */
        display: flex;
        flex-direction: row;
        /* ƒê·ªïi th√†nh h√†ng ngang ƒë·ªÉ chia c·ªôt */
        overflow: hidden;
    }

    /* SIDEBAR (DANH S√ÅCH NH√ìM) */
    .sidebar {
        width: 280px;
        background: rgba(244, 247, 246, 0.8);
        border-right: 1px solid rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
    }

    .sidebar-header {
        padding: 20px;
        font-weight: 800;
        color: #1A2980;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .group-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }

    .group-item {
        padding: 12px 15px;
        margin-bottom: 5px;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 600;
        color: #555;
    }

    .group-item:hover,
    .group-item.active {
        background: white;
        color: #1A2980;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }

    /* RIGHT SIDEBAR (TH√ÄNH VI√äN ONLINE) */
    .user-sidebar {
        width: 240px;
        background: rgba(255, 255, 255, 0.9);
        border-left: 1px solid rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
    }
    .user-list { flex: 1; overflow-y: auto; padding: 10px; }
    .user-item {
        padding: 8px 10px; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; color: #555;
    }
    .status-dot {
        width: 8px; height: 8px; background: #ccc; border-radius: 50%;
    }
    .status-dot.online {
        background: #2ecc71; box-shadow: 0 0 5px #2ecc71;
    }

    /* MAIN CHAT AREA */
    .main-chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* 3. HEADER */
    .chat-header {
        padding: 15px 25px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        /* Kh√¥ng b·ªã co l·∫°i */
    }

    .chat-title {
        color: #1A2980;
        font-weight: 800;
        font-size: 1.4rem;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: -0.5px;
    }

    /* 4. DANH S√ÅCH TIN NH·∫ÆN (Cu·ªôn d·ªçc) */
    .chat-box {
        flex: 1;
        /* T·ª± ƒë·ªông gi√£n ƒë·ªÉ chi·∫øm h·∫øt ch·ªó tr·ªëng */
        padding: 20px;
        overflow-y: auto;
        /* Ch·ªâ cu·ªôn ri√™ng ph·∫ßn tin nh·∫Øn */
        background: #f4f7f6;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    /* BONG B√ìNG CHAT */
    .message-item {
        display: flex;
        flex-direction: column;
        max-width: 75%;
        /* Tin nh·∫Øn d√†i h∆°n x√≠u */
    }

    .message-content {
        padding: 12px 18px;
        border-radius: 20px;
        font-size: 1rem;
        font-weight: 600;
        line-height: 1.5;
        word-wrap: break-word;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .message-info {
        font-size: 0.75rem;
        margin-top: 5px;
        opacity: 0.7;
        font-weight: 700;
    }

    /* Tin ng∆∞·ªùi kh√°c (Tr√°i) */
    .msg-left {
        align-self: flex-start;
    }

    .msg-left .message-content {
        background: white;
        color: #333;
        border: 1px solid #e1e8ed;
        border-bottom-left-radius: 2px;
    }

    .msg-left .message-info {
        margin-left: 10px;
        color: #555;
    }

    /* Tin c·ªßa m√¨nh (Ph·∫£i) */
    .msg-right {
        align-self: flex-end;
    }

    .msg-right .message-content {
        background: linear-gradient(135deg, #1A2980 0%, #26D0CE 100%);
        color: white;
        border-bottom-right-radius: 2px;
        box-shadow: 0 5px 15px rgba(38, 208, 206, 0.3);
    }

    .msg-right .message-info {
        margin-right: 10px;
        text-align: right;
        color: #1A2980;
    }

    /* 5. KHUNG NH·∫¨P LI·ªÜU (Footer) */
    .chat-input-area {
        padding: 15px 25px;
        background: white;
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        display: flex;
        gap: 15px;
        align-items: center;
        flex-shrink: 0;
        /* Kh√¥ng b·ªã co l·∫°i */
    }

    .input-mess {
        flex: 1;
        border-radius: 50px;
        padding: 14px 25px;
        border: 2px solid #eaeff2;
        background: #f9f9f9;
        font-weight: 600;
        font-size: 1rem;
        outline: none;
        transition: all 0.3s;
    }

    .input-mess:focus {
        border-color: #26D0CE;
        background: white;
        box-shadow: 0 0 0 4px rgba(38, 208, 206, 0.1);
    }

    .btn-send {
        background: linear-gradient(135deg, #1A2980 0%, #26D0CE 100%);
        color: white;
        border: none;
        width: 55px;
        height: 55px;
        border-radius: 50%;
        font-size: 1.4rem;
        cursor: pointer;
        transition: transform 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 5px 15px rgba(26, 41, 128, 0.3);
    }

    .btn-send:hover {
        transform: scale(1.1) rotate(-10deg);
    }

    /* Thanh cu·ªôn ƒë·∫πp */
    .chat-box::-webkit-scrollbar {
        width: 6px;
    }

    .chat-box::-webkit-scrollbar-thumb {
        background: #bbb;
        border-radius: 10px;
    }

    .chat-box::-webkit-scrollbar-track {
        background: transparent;
    }
</style>

<div class="chat-wrapper">
    <div class="chat-card">

        <!-- SIDEBAR TR√ÅI -->
        <div class="sidebar">
            <div class="sidebar-header">
                <span>DANH S√ÅCH NH√ìM</span>
                <button class="btn btn-sm btn-primary rounded-circle" onclick="createNewGroup()"
                    title="T·∫°o nh√≥m m·ªõi">+</button>
            </div>
            <div class="group-list" id="groupList">
                <!-- Danh s√°ch nh√≥m s·∫Ω load v√†o ƒë√¢y -->
                <div class="text-center mt-3 text-muted small">ƒêang t·∫£i...</div>
            </div>
        </div>

        <!-- KHUNG CHAT PH·∫¢I -->
        <div class="main-chat-area">
            <div class="chat-header">
                <h3 class="chat-title" id="currentRoomName">üí¨ Chat Chung</h3>
                <div
                    style="display: flex; align-items: center; gap: 8px; background: rgba(46, 204, 113, 0.1); padding: 5px 15px; border-radius: 20px;">
                    <span
                        style="width: 8px; height: 8px; background: #2ecc71; border-radius: 50%; box-shadow: 0 0 5px #2ecc71;"></span>
                    <span
                        style="font-weight: 800; font-size: 0.85rem; color: #2ecc71; text-transform: uppercase;">Online</span>
                </div>
            </div>

            <div class="chat-box" id="chatBox">
                @if (Model != null)
                {
                    foreach (var msg in Model)
                    {
                        bool isMine = msg.SenderName == User.Identity.Name;
                        <div class="message-item @(isMine ? "msg-right" : "msg-left")">
                            <div class="message-content">@msg.Content</div>
                            <div class="message-info">@(isMine ? "B·∫°n" : msg.SenderName) ‚Ä¢ @msg.Timestamp.ToString("HH:mm")
                            </div>
                        </div>
                    }
                }
            </div>

            <div class="chat-input-area">
                <input type="text" id="messageInput" class="input-mess" placeholder="Nh·∫≠p tin nh·∫Øn..."
                    autocomplete="off">
                <button id="sendButton" class="btn-send">‚û§</button>
            </div>
        <div class="chat-box" id="chatBox">
            <!-- Tin nh·∫Øn s·∫Ω ƒë∆∞·ª£c n·∫°p v√†o ƒë√¢y b·∫±ng JavaScript -->
        </div>

        <!-- SIDEBAR PH·∫¢I (ONLINE MEMBERS) -->
        <div class="user-sidebar">
            <div class="sidebar-header" style="font-size: 0.9rem;">
                <span>TH√ÄNH VI√äN ONLINE</span>
            </div>
            <div class="user-list" id="userList">
                <!-- Danh s√°ch user s·∫Ω load v√†o ƒë√¢y -->
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
<!-- Truy·ªÅn bi·∫øn currentUser sang file JS ngo√†i -->
<script>
    var currentUser = "@User.Identity.Name";
    var currentGroup = ""; // M·∫∑c ƒë·ªãnh l√† chat chung ho·∫∑c r·ªóng
    var currentGroupId = 0;

    // 1. NH·∫¨N TIN NH·∫ÆN (Chung cho c·∫£ Group v√† Private)
    connection.on("ReceiveMessage", function (user, message, time) {
        // TODO: N·∫øu mu·ªën chia tin nh·∫Øn theo nh√≥m, c·∫ßn ki·ªÉm tra th√™m tham s·ªë groupName t·ª´ server g·ª≠i v·ªÅ
        // ·ªû ƒë√¢y t·∫°m th·ªùi hi·ªÉn th·ªã h·∫øt ƒë·ªÉ test
        if (!currentGroup) {
            appendMessage(user, message, time);
        }
    });

    // Nh·∫≠n tin nh·∫Øn nh√≥m (C·∫ßn update ChatHub ƒë·ªÉ d√πng h√†m n√†y n·∫øu mu·ªën t√°ch bi·ªát)
    connection.on("ReceiveGroupMessage", function (user, groupName, message, time) {
        if (groupName !== currentGroup) return; // Ch·ªâ hi·ªán n·∫øu ƒëang ·ªü ƒë√∫ng ph√≤ng
        appendMessage(user, message, time);
    });

    // 2. NH·∫¨N DANH S√ÅCH ONLINE (M·ªöI)
    connection.on("UpdateGroupUsers", function (users) {
        var listHtml = "";
        users.forEach(u => {
            // User hi·ªán t·∫°i th√¨ in ƒë·∫≠m
            var nameDisplay = (u === currentUser) ? `<b>${u} (B·∫°n)</b>` : u;
            listHtml += `<div class="user-item"><span class="status-dot online"></span> ${nameDisplay}</div>`;
        });
        document.getElementById("userList").innerHTML = listHtml;
    });

    // H√†m ph·ª• tr·ª£ ƒë·ªÉ hi·ªÉn th·ªã tin nh·∫Øn l√™n giao di·ªán
    function appendMessage(user, message, time) {
        var chatBox = document.getElementById("chatBox");
        var isMine = (user === currentUser);
        var divItem = document.createElement("div");
        divItem.className = isMine ? "message-item msg-right" : "message-item msg-left";
        divItem.innerHTML = `<div class="message-content">${message}</div><div class="message-info">${isMine ? "B·∫°n" : user} ‚Ä¢ ${time}</div>`;
        chatBox.appendChild(divItem);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    connection.start().catch(err => console.error(err.toString()));

    document.getElementById("sendButton").addEventListener("click", function (event) {
        var input = document.getElementById("messageInput");
        if (input.value.trim() !== "") {
            // N·∫øu c√≥ currentGroup th√¨ g·ª≠i GroupMessage, kh√¥ng th√¨ g·ª≠i chung
            if (currentGroup) {
                connection.invoke("SendGroupMessage", currentGroup, input.value).catch(err => console.error(err.toString()));
            } else {
                connection.invoke("SendMessage", "", input.value).catch(err => console.error(err.toString()));
            }
            input.value = ""; input.focus();
        }
        event.preventDefault();
    });

    document.getElementById("messageInput").addEventListener("keyup", function (event) {
        if (event.key === "Enter") document.getElementById("sendButton").click();
    });

    window.onload = function () {
        loadGroups(); // ƒê·ªïi t√™n h√†m
        var chatBox = document.getElementById("chatBox");
        chatBox.scrollTop = chatBox.scrollHeight;
    };

    // --- C√ÅC H√ÄM X·ª¨ L√ù NH√ìM ---

    function loadGroups() {
        // G·ªçi API l·∫•y t·∫•t c·∫£ nh√≥m
        fetch('/Group/GetAllGroups')
            .then(response => response.json())
            .then(data => {
                var listHtml = "";
                data.forEach(g => {
                    // N·∫øu ch∆∞a tham gia th√¨ hi·ªán ch·ªØ nh·∫°t h∆°n ho·∫∑c ghi ch√∫
                    var statusClass = g.isJoined ? "" : "text-muted fst-italic";
                    var statusText = g.isJoined ? "" : " (Ch∆∞a tham gia)";
                    
                    // Truy·ªÅn th√™m bi·∫øn isJoined v√†o h√†m x·ª≠ l√Ω click
                    listHtml += `<div class="group-item ${statusClass}" onclick="handleGroupClick(${g.id}, '${g.name}', ${g.isJoined})"># ${g.name}${statusText}</div>`;
                });
                document.getElementById("groupList").innerHTML = listHtml;
            });
    }

    function handleGroupClick(groupId, groupName, isJoined) {
        if (isJoined) {
            joinRoom(groupId, groupName);
        } else {
            // N·∫øu ch∆∞a tham gia -> G·ªçi API JoinGroup tr∆∞·ªõc
            fetch('/Group/JoinGroup?groupId=' + groupId, { method: 'POST' })
                .then(res => {
                    if (res.ok) {
                        // Tham gia th√†nh c√¥ng -> Load l·∫°i danh s√°ch ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i -> V√†o ph√≤ng
                        loadGroups(); 
                        joinRoom(groupId, groupName);
                    } else {
                        alert("Kh√¥ng th·ªÉ tham gia nh√≥m n√†y.");
                    }
                });
        }
    }

    function joinRoom(groupId, groupName) {
        currentGroup = groupName;
        currentGroupId = groupId;
        document.getElementById("currentRoomName").innerText = "üí¨ " + groupName;

        // X√≥a chat c≈© (ho·∫∑c load l·∫°i t·ª´ API n·∫øu c√≥)
        var chatBox = document.getElementById("chatBox");
        chatBox.innerHTML = '<div class="text-center text-muted mt-3">ƒêang t·∫£i tin nh·∫Øn...</div>';
        document.getElementById("userList").innerHTML = '<div class="text-center text-muted small mt-2">ƒêang t·∫£i...</div>';

        // G·ªçi API l·∫•y l·ªãch s·ª≠ chat
        fetch('/Group/GetGroupHistory?groupId=' + groupId)
            .then(res => res.json())
            .then(msgs => {
                chatBox.innerHTML = ''; // X√≥a loading
                if (msgs.length === 0) chatBox.innerHTML = '<div class="text-center text-muted mt-3">Ch∆∞a c√≥ tin nh·∫Øn n√†o.</div>';
                msgs.forEach(m => appendMessage(m.sender, m.content, m.timestamp));
            });

        // G·ªçi SignalR ƒë·ªÉ join
        connection.invoke("JoinRoom", groupName).catch(err => console.error(err.toString()));
    }

    function createNewGroup() {
        var name = prompt("Nh·∫≠p t√™n nh√≥m m·ªõi:");
        if (name) {
            fetch('/Group/CreateGroup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(name)
            })
                .then(async res => {
                    if (res.ok) {
                        loadGroups(); // Load l·∫°i danh s√°ch
                        alert("T·∫°o nh√≥m th√†nh c√¥ng!");
                    } else {
                        // ƒê·ªçc n·ªôi dung l·ªói chi ti·∫øt t·ª´ Backend g·ª≠i v·ªÅ
                        var errorText = await res.text();
                        alert("L·ªói t·∫°o nh√≥m: " + errorText);
                    }
                });
        }
    }
</script>
</script>
<script src="~/js/chat.js"></script>
>>>>>>> ff5dd8f3d9daa7e85f286ef4f55d6e477995bd78
