@model List<RealTimeChatMVC.Models.Message>

@{
    ViewData["Title"] = "Ph√≤ng Chat";
}

<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700;800&display=swap" rel="stylesheet">

<style>
    /* 1. KHUNG BAO NGO√ÄI */
    .chat-wrapper {
        font-family: 'Quicksand', sans-serif;
        height: 85vh; /* Chi·ªÅu cao c·ªë ƒë·ªãnh ƒë·ªÉ kh√¥ng b·ªã tr√†n m√†n h√¨nh */
        display: flex;
        justify-content: center;
        align-items: center;
        padding-top: 20px;
    }

    /* 2. TH·∫∫ CHAT (GLASS) */
    .chat-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 25px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 900px; /* R·ªông h∆°n form ƒëƒÉng k√Ω ƒë·ªÉ chat tho·∫£i m√°i */
        height: 100%;
        display: flex;
        flex-direction: column; /* X·∫øp d·ªçc: Header - List - Input */
        overflow: hidden;
    }

    /* 3. HEADER */
    .chat-header {
        padding: 20px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
        background: rgba(255,255,255,0.5);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .chat-title {
        color: #1A2980;
        font-weight: 800;
        font-size: 1.5rem;
        margin: 0;
        text-transform: uppercase;
    }

    /* 4. DANH S√ÅCH TIN NH·∫ÆN (Cu·ªôn d·ªçc) */
    .chat-box {
        flex: 1; /* Chi·∫øm h·∫øt kho·∫£ng tr·ªëng c√≤n l·∫°i */
        padding: 20px;
        overflow-y: auto; /* Cho ph√©p cu·ªôn */
        background: #f4f7f6;
        display: flex;
        flex-direction: column;
        gap: 15px; /* Kho·∫£ng c√°ch gi·ªØa c√°c tin */
    }

    /* BONG B√ìNG CHAT */
    .message-item {
        display: flex;
        flex-direction: column;
        max-width: 70%;
    }

    .message-content {
        padding: 12px 18px;
        border-radius: 20px;
        font-size: 1rem;
        font-weight: 600;
        line-height: 1.4;
        position: relative;
        word-wrap: break-word;
    }

    .message-info {
        font-size: 0.75rem;
        margin-top: 5px;
        opacity: 0.7;
    }

    /* Tin nh·∫Øn c·ªßa NG∆Ø·ªúI KH√ÅC (B√™n Tr√°i) */
    .msg-left {
        align-self: flex-start; /* CƒÉn tr√°i */
    }
    .msg-left .message-content {
        background: white;
        color: #333;
        border: 1px solid #e1e8ed;
        border-bottom-left-radius: 5px; /* G√≥c nh·ªçn */
    }
    .msg-left .message-info { margin-left: 5px; }

    /* Tin nh·∫Øn c·ªßa T√îI (B√™n Ph·∫£i) */
    .msg-right {
        align-self: flex-end; /* CƒÉn ph·∫£i */
        align-items: flex-end;
    }
    .msg-right .message-content {
        background: linear-gradient(135deg, #1A2980 0%, #26D0CE 100%);
        color: white;
        border-bottom-right-radius: 5px; /* G√≥c nh·ªçn */
        box-shadow: 0 5px 15px rgba(38, 208, 206, 0.3);
    }
.msg-right .message-info { margin-right: 5px; }

    /* 5. KHUNG NH·∫¨P LI·ªÜU (Footer) */
    .chat-input-area {
        padding: 20px;
        background: white;
        border-top: 1px solid rgba(0,0,0,0.1);
        display: flex;
        gap: 10px;
    }

    .input-mess {
        flex: 1;
        border-radius: 50px;
        padding: 15px 25px;
        border: 2px solid #eaeff2;
        background: #f9f9f9;
        font-weight: 600;
        outline: none;
    }
    .input-mess:focus {
        border-color: #26D0CE;
        background: white;
    }

    .btn-send {
        background: #1A2980;
        color: white;
        border: none;
        width: 55px;
        height: 55px;
        border-radius: 50%; /* N√∫t tr√≤n */
        font-size: 1.2rem;
        cursor: pointer;
        transition: transform 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .btn-send:hover {
        transform: scale(1.1);
        background: #26D0CE;
    }

    /* T√πy ch·ªânh thanh cu·ªôn cho ƒë·∫πp */
    .chat-box::-webkit-scrollbar { width: 6px; }
    .chat-box::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
</style>

<div class="chat-wrapper">
    <div class="chat-card">
        <div class="chat-header">
            <h3 class="chat-title">üí¨ C·ªông ƒê·ªìng BizFlow</h3>
            <span class="badge bg-primary rounded-pill">Online</span>
        </div>

        <div class="chat-box" id="chatBox">
            @if (Model != null)
            {
                foreach (var msg in Model)
                {
                    // Ki·ªÉm tra xem tin nh·∫Øn n√†y c·ªßa ai ƒë·ªÉ x·∫øp tr√°i/ph·∫£i
                    // L∆∞u √Ω: User.Identity.Name l√† ng∆∞·ªùi ƒëang ƒëƒÉng nh·∫≠p
                    bool isMine = msg.SenderName == User.Identity.Name;
                    
                    <div class="message-item @(isMine ? "msg-right" : "msg-left")">
                        <div class="message-content">
                            @msg.Content
                        </div>
                        <div class="message-info">
                            @(isMine ? "B·∫°n" : msg.SenderName) ‚Ä¢ @msg.Timestamp.ToString("HH:mm")
                        </div>
                    </div>
                }
            }
        </div>

        <div class="chat-input-area">
            <input type="text" id="messageInput" class="input-mess" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off">
            <button id="sendButton" class="btn-send">‚û§</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
<script>
    // 1. K·∫øt n·ªëi t·ªõi Hub
    var connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();
    
    // T√™n ng∆∞·ªùi d√πng hi·ªán t·∫°i (L·∫•y t·ª´ Server)
    var currentUser = "@User.Identity.Name";

    // 2. Nh·∫≠n tin nh·∫Øn t·ª´ Server
connection.on("ReceiveMessage", function (user, message, time) {
        var chatBox = document.getElementById("chatBox");
        
        // Ki·ªÉm tra xem tin nh·∫Øn v·ª´a nh·∫≠n l√† c·ªßa m√¨nh hay ng∆∞·ªùi kh√°c
        var isMine = (user === currentUser);
        
        // T·∫°o th·∫ª HTML m·ªõi
        var divItem = document.createElement("div");
        divItem.className = isMine ? "message-item msg-right" : "message-item msg-left";
        
        divItem.innerHTML = `
            <div class="message-content">${message}</div>
            <div class="message-info">${isMine ? "B·∫°n" : user} ‚Ä¢ ${time}</div>
        `;

        // Th√™m v√†o chatbox
        chatBox.appendChild(divItem);
        
        // T·ª± ƒë·ªông cu·ªôn xu·ªëng ƒë√°y
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    // 3. B·∫Øt ƒë·∫ßu k·∫øt n·ªëi
    connection.start().catch(err => console.error(err.toString()));

    // 4. X·ª≠ l√Ω n√∫t G·ª≠i
    document.getElementById("sendButton").addEventListener("click", function (event) {
        var input = document.getElementById("messageInput");
        var message = input.value;
        
        if(message.trim() !== "") {
            connection.invoke("SendMessage", currentUser, message).catch(err => console.error(err.toString()));
            input.value = ""; // X√≥a √¥ nh·∫≠p
            input.focus();    // Gi·ªØ chu·ªôt ·ªü √¥ nh·∫≠p
        }
        event.preventDefault();
    });

    // 5. B·∫•m Enter c≈©ng g·ª≠i ƒë∆∞·ª£c
    document.getElementById("messageInput").addEventListener("keyup", function(event) {
        if (event.key === "Enter") {
            document.getElementById("sendButton").click();
        }
    });

    
    window.onload = function() {
        var chatBox = document.getElementById("chatBox");
        chatBox.scrollTop = chatBox.scrollHeight;
    };
</script>